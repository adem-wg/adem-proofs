theory ADEM begin

// Function signature and definition of the equational theory E

functions: fst/1, pair/2, pk/1, sha256/1, sign/2, snd/1,
           tlsClientMsg/4, tlsClientReceive/2, tlsServerMsg/4,
           tlsServerReceive/2, true/0, verify/3
equations:
    fst(<x.1, x.2>) = x.1,
    snd(<x.1, x.2>) = x.2,
    tlsClientReceive(tlsServerMsg(~sess, domain, ~sk, m), ~sess) = m,
    tlsServerReceive(tlsClientMsg(~sess, domain, pk(~sk), m), ~sk)
  = ~sess,
    tlsServerReceive(tlsClientMsg(~sess, domain, pk(~sk), m), ~sk) = m,
    verify(sign(x.1, x.2), x.1, pk(x.2)) = true



heuristic: o "./oracle.py"

/*
looping facts with injective instances:
  VerifyAuthorityEndorsements/4
*/



rule (modulo E) DomainRegister:
   [ DomainRegister( $A, d ) ]
  --[ OnlyOnce( <'domain_register', d> ), NoTuple( d ) ]->
   [ !DomainOwner( $A, d ) ]

  /* has exactly the trivial AC variant */

restriction NoTuple:
  "∀ m #t. (NoTuple( m ) @ #t) ⇒ (¬(∃ l r. m = <l, r>))"
  // safety formula

rule (modulo E) SubdomainRegister:
   [ DomainRegister( $A, <d, sub> ), !DomainOwner( $A, d ) ]
  --[ OnlyOnce( <'domain_register', d, sub> ) ]->
   [ !DomainOwner( $A, <d, sub> ) ]

  // loop breaker: [1]
  /* has exactly the trivial AC variant */

rule (modulo E) DomainCompromise:
   [ In( $A ), In( d ) ]
  --[
  CompromisedDomainOwner( $A ), CompromisedParty( $A ),
  SomeCompromise( )
  ]->
   [ DomainRegister( $A, d ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) LogRegister:
   [ ] --[ IsLog( $Log ) ]-> [ !Log( $Log ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Submit:
   [
   !CA( $CA, skCA ), !Log( $Log ),
   In( <<'cert', $CA, d, pk>, certSig> )
   ]
  --[
  Eq( verify(certSig, <'cert', $CA, d, pk>, pk(skCA)), true ),
  Eq( fst(snd(<'cert', $CA, d, pk>)), $CA ),
  LogInclusion( $Log, <<'cert', $CA, d, pk>, certSig> )
  ]->
   [ !MHTLeaf( $Log, <<'cert', $CA, d, pk>, certSig> ) ]

  /*
  rule (modulo AC) Submit:
     [
     !CA( $CA, skCA ), !Log( $Log ),
     In( <<'cert', $CA, d, pk>, certSig> )
     ]
    --[
    Eq( z, true ), Eq( $CA, $CA ),
    LogInclusion( $Log, <<'cert', $CA, d, pk>, certSig> )
    ]->
     [ !MHTLeaf( $Log, <<'cert', $CA, d, pk>, certSig> ) ]
    variants (modulo AC)
    1. $CA   = $CA.15
       certSig
             = certSig.17
       d     = d.18
       pk    = pk.19
       skCA  = skCA.20
       z     = verify(certSig.17, <'cert', $CA.15, d.18, pk.19>,
                      pk(skCA.20))
    
    2. $CA   = $CA.15
       certSig
             = sign(<'cert', $CA.15, d.18, pk.19>, skCA.20)
       d     = d.18
       pk    = pk.19
       skCA  = skCA.20
       z     = true
  */

rule (modulo E) AdversarialAppend:
   [ In( msg ) ]
  --[
  LogInclusion( $Log, msg ), CompromisedParty( $Log ),
  SomeCompromise( )
  ]->
   [ !MHTLeaf( $Log, msg ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) CA:
   [ Fr( ~skCA ) ]
  --[ CASk( $CA, ~skCA ), OnlyOnce( <'CA', $CA> ) ]->
   [ !CA( $CA, ~skCA ), Out( pk(~skCA) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) FraudulentCertificate:
   [ !CA( $CA, ~skCA ), In( m ) ]
  --[
  SigningOracleCA( $CA, m ), CompromisedCA( $CA ),
  CompromisedParty( $CA ), SomeCompromise( )
  ]->
   [ Out( sign(m, ~skCA) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) TLSKeyRegister:
   [ !DomainOwner( $A, d ), !CA( $CA, skCA ), Fr( ~skUser ) ]
  --[ OnlyOnce( <'tls_key', d> ), TLSKeyGen( ~skUser ) ]->
   [ !TLSKey( $A, $CA, d, ~skUser ), Out( pk(~skUser) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) TLSKeyShare:
   [ !TLSKey( $A, $CA, d1, ~skUser ), !DomainOwner( $A, d2 ) ]
  --[
  TLSKeyShare( ~skUser ), OnlyOnce( <'tls_key', d2> ),
  Eq( d1, fst(d2) )
  ]->
   [ !TLSKey( $A, $CA, d2, ~skUser ) ]

  // loop breaker: [0]
  /*
  rule (modulo AC) TLSKeyShare:
     [ !TLSKey( $A, $CA, d1, ~skUser ), !DomainOwner( $A, d2 ) ]
    --[
    TLSKeyShare( ~skUser ), OnlyOnce( <'tls_key', d2> ), Eq( d1, z )
    ]->
     [ !TLSKey( $A, $CA, d2, ~skUser ) ]
    variants (modulo AC)
    1. d2    = d2.9
       z     = fst(d2.9)
    
    2. d2    = <z.10, x.12>
       z     = z.10
    // loop breaker: [0]
  */

rule (modulo E) TLSKeyLeak:
   [ !TLSKey( $A, $CA, d, ~skUser ) ]
  --[ CompromisedTLSKey( ~skUser ), SomeCompromise( ) ]->
   [ Out( ~skUser ) ]

  /* has exactly the trivial AC variant */

lemma TLSKeyShareRecursion [use_induction, reuse]:
  all-traces
  "∀ k #t1. (TLSKeyShare( k ) @ #t1) ⇒ (∃ #t2. TLSKeyGen( k ) @ #t2)"
/*
guarded formula characterizing all counter-examples:
"∃ k #t1.
  (TLSKeyShare( k ) @ #t1) ∧ ∀ #t2. (TLSKeyGen( k ) @ #t2) ⇒ ⊥"
*/
induction
  case empty_trace
  by contradiction /* from formulas */
next
  case non_empty_trace
  simplify
  solve( (last(#t1))  ∥
         (∃ #t2. (TLSKeyGen( ~skUser ) @ #t2) ∧ ¬(last(#t2))) )
    case case_1
    solve( splitEqs(0) )
      case split_case_1
      solve( !TLSKey( $A, $CA, d1, ~skUser ) ▶₀ #t1 )
        case TLSKeyRegister_case_1
        by contradiction /* from formulas */
      next
        case TLSKeyRegister_case_2
        by contradiction /* from formulas */
      next
        case TLSKeyRegister_case_3
        by contradiction /* from formulas */
      next
        case TLSKeyRegister_case_4
        by contradiction /* from formulas */
      next
        case TLSKeyShare_case_1
        by contradiction /* from formulas */
      next
        case TLSKeyShare_case_2
        by contradiction /* from formulas */
      next
        case TLSKeyShare_case_3
        by contradiction /* from formulas */
      next
        case TLSKeyShare_case_4
        by contradiction /* from formulas */
      qed
    next
      case split_case_2
      solve( !TLSKey( $A, $CA, fst(d2), ~skUser ) ▶₀ #t1 )
        case TLSKeyRegister
        by contradiction /* from formulas */
      next
        case TLSKeyShare
        by contradiction /* from formulas */
      qed
    qed
  next
    case case_2
    by contradiction /* from formulas */
  qed
qed

lemma TLSKeyLeakRecursion [use_induction, reuse]:
  all-traces
  "∀ k #t.
    (CompromisedTLSKey( k ) @ #t) ⇒ (∃ #x. TLSKeyGen( k ) @ #x)"
/*
guarded formula characterizing all counter-examples:
"∃ k #t.
  (CompromisedTLSKey( k ) @ #t) ∧ ∀ #x. (TLSKeyGen( k ) @ #x) ⇒ ⊥"
*/
induction
  case empty_trace
  by contradiction /* from formulas */
next
  case non_empty_trace
  simplify
  solve( (last(#t))  ∥
         (∃ #x. (TLSKeyGen( ~skUser ) @ #x) ∧ ¬(last(#x))) )
    case case_1
    solve( !TLSKey( $A, $CA, d, ~skUser ) ▶₀ #t )
      case TLSKeyRegister_case_1
      by contradiction /* from formulas */
    next
      case TLSKeyRegister_case_2
      by contradiction /* from formulas */
    next
      case TLSKeyRegister_case_3
      by contradiction /* from formulas */
    next
      case TLSKeyRegister_case_4
      by contradiction /* from formulas */
    next
      case TLSKeyShare_case_1
      by contradiction /* from formulas */
    next
      case TLSKeyShare_case_2
      by contradiction /* from formulas */
    next
      case TLSKeyShare_case_3
      by contradiction /* from formulas */
    next
      case TLSKeyShare_case_4
      by contradiction /* from formulas */
    qed
  next
    case case_2
    by contradiction /* from formulas */
  qed
qed

lemma WrongCAKeyUseImpliesCompromise [reuse]:
  all-traces
  "∀ tag m ca caSk #t1 #t2.
    (((CASk( ca, caSk ) @ #t1) ∧
      (!KU( <<tag, m>, sign(<'tag', m>, caSk)> ) @ #t2)) ∧
     (¬(tag = 'cert'))) ⇒
    (∃ #x. (CompromisedCA( ca ) @ #x) ∧ (CompromisedParty( ca ) @ #x))"
/*
guarded formula characterizing all counter-examples:
"∃ tag m ca caSk #t1 #t2.
  (CASk( ca, caSk ) @ #t1) ∧
  (!KU( <<tag, m>, sign(<'tag', m>, caSk)> ) @ #t2)
 ∧
  (¬(tag = 'cert')) ∧
  (∀ #x.
    (CompromisedCA( ca ) @ #x) ∧ (CompromisedParty( ca ) @ #x) ⇒ ⊥)"
*/
simplify
solve( !KU( sign(<'tag', m>, ~skCA) ) @ #vk.3 )
  case FraudulentCertificate
  by contradiction /* from formulas */
next
  case c_sign
  by solve( !KU( ~skCA ) @ #vk.5 )
qed

rule (modulo E) CertificateRequest:
   [
   !DomainOwner( $A, d ), !TLSKey( $A, $CA, d, ~skTLS ),
   !CA( $CA, ~skCA )
   ]
  --[ OnlyOnce( <'certificate', d> ) ]->
   [ Out( sign(<'cert', $CA, d, pk(~skTLS)>, ~skCA) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Ltk:
   [ Fr( ~rootKey ) ]
  -->
   [ !Ltk( $A, ~rootKey ), Out( pk(~rootKey) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) AssetKey:
   [ Fr( ~assetKey ) ]
  -->
   [ !LtkAsset( $A, ~assetKey ), Out( pk(~assetKey) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Reveal:
   [ !Ltk( $A, ~ltk ) ]
  --[
  CompromisedADEMParty( $A, pk(~ltk) ), CompromisedParty( $A ),
  SomeCompromise( )
  ]->
   [ Out( ~ltk ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) RevealAsset:
   [ !LtkAsset( $A, ~ltk ) ]
  --[
  CompromisedAssetKey( $A, pk(~ltk) ), CompromisedParty( $A ),
  SomeCompromise( )
  ]->
   [ Out( ~ltk ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) RootSetupDomains:
   [ !Ltk( $Party, ~rootKey ) ]
  --[
  OnlyOnce( <'root', $OI> ), IsRootPK( $Party, $OI, pk(~rootKey) ),
  OI( $Party, $OI )
  ]->
   [
   DomainRegister( $Party, $OI ),
   DomainRegister( $Party, <$OI, sha256(pk(~rootKey))> ),
   !RootDomains( $Party, ~rootKey, $OI, <$OI, sha256(pk(~rootKey))> )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) RootSetupCertificates:
   [
   !CA( $CA, skCA ), !RootDomains( $P, ~rootKey, oi, rootD ),
   !TLSKey( $P, $CA, oi, tlsSk ), !TLSKey( $P, $CA, rootD, tlsSk ),
   !MHTLeaf( $Log, <<'cert', $CA, oi, pk(tlsSk)>, sigOiCert> ),
   !MHTLeaf( $Log, <<'cert', $CA, rootD, pk(tlsSk)>, sigRootCert> )
   ]
  --[
  OnlyOnce( <'root_setup', oi> ),
  Eq( verify(sigOiCert, <'cert', $CA, oi, pk(tlsSk)>, pk(skCA)), true
  ),
  Eq( verify(sigRootCert, <'cert', $CA, rootD, pk(tlsSk)>, pk(skCA)),
      true
  )
  ]->
   [ !RootSetup( $P, ~rootKey, oi, rootD ) ]

  /*
  rule (modulo AC) RootSetupCertificates:
     [
     !CA( $CA, skCA ), !RootDomains( $P, ~rootKey, oi, rootD ),
     !TLSKey( $P, $CA, oi, tlsSk ), !TLSKey( $P, $CA, rootD, tlsSk ),
     !MHTLeaf( $Log, <<'cert', $CA, oi, pk(tlsSk)>, sigOiCert> ),
     !MHTLeaf( $Log, <<'cert', $CA, rootD, pk(tlsSk)>, sigRootCert> )
     ]
    --[ OnlyOnce( <'root_setup', oi> ), Eq( z, true ), Eq( z.1, true )
    ]->
     [ !RootSetup( $P, ~rootKey, oi, rootD ) ]
    variants (modulo AC)
    1. $CA   = $CA.25
       oi    = oi.29
       rootD = rootD.30
       sigOiCert
             = sigOiCert.31
       sigRootCert
             = sigRootCert.32
       skCA  = skCA.33
       tlsSk = tlsSk.34
       z     = verify(sigOiCert.31, <'cert', $CA.25, oi.29, pk(tlsSk.34)>,
                      pk(skCA.33))
       z.1   = verify(sigRootCert.32,
                      <'cert', $CA.25, rootD.30, pk(tlsSk.34)>, pk(skCA.33))
    
    2. $CA   = $CA.25
       oi    = oi.29
       rootD = rootD.30
       sigOiCert
             = sigOiCert.31
       sigRootCert
             = sign(<'cert', $CA.25, rootD.30, pk(tlsSk.34)>, skCA.33)
       skCA  = skCA.33
       tlsSk = tlsSk.34
       z     = verify(sigOiCert.31, <'cert', $CA.25, oi.29, pk(tlsSk.34)>,
                      pk(skCA.33))
       z.1   = true
    
    3. $CA   = $CA.25
       oi    = oi.29
       rootD = rootD.30
       sigOiCert
             = sign(<'cert', $CA.25, oi.29, pk(tlsSk.34)>, skCA.33)
       sigRootCert
             = sigRootCert.32
       skCA  = skCA.33
       tlsSk = tlsSk.34
       z     = true
       z.1   = verify(sigRootCert.32,
                      <'cert', $CA.25, rootD.30, pk(tlsSk.34)>, pk(skCA.33))
    
    4. $CA   = $CA.25
       oi    = oi.29
       rootD = rootD.30
       sigOiCert
             = sign(<'cert', $CA.25, oi.29, pk(tlsSk.34)>, skCA.33)
       sigRootCert
             = sign(<'cert', $CA.25, rootD.30, pk(tlsSk.34)>, skCA.33)
       skCA  = skCA.33
       tlsSk = tlsSk.34
       z     = true
       z.1   = true
  */

rule (modulo E) RootKeyLearn:
   [
   !CA( $CA, skCA ), !Log( $Log ),
   !MHTLeaf( $Log, <<'cert', $CA, oi, tlsPk>, certOiSig> ),
   !MHTLeaf( $Log,
             <<'cert', $CA, <oi, rootKeyHash>, tlsPk>, certRootDSig>
   )
   ]
  --[
  Eq( verify(certOiSig, <'cert', $CA, oi, tlsPk>, pk(skCA)), true ),
  Eq( verify(certRootDSig, <'cert', $CA, <oi, rootKeyHash>, tlsPk>,
             pk(skCA)),
      true
  ),
  VerifiedRootKey( oi, rootKeyHash ),
  RootCertVerified( <<'cert', $CA, <oi, rootKeyHash>, tlsPk>, 
                     certRootDSig>
  ),
  LogInclusionVerified( $Log, <'cert', $CA, oi, tlsPk> ),
  LogInclusionVerified( $Log, <'cert', $CA, <oi, rootKeyHash>, tlsPk>
  )
  ]->
   [ RootKeyVerified( oi, rootKeyHash ) ]

  /*
  rule (modulo AC) RootKeyLearn:
     [
     !CA( $CA, skCA ), !Log( $Log ),
     !MHTLeaf( $Log, <<'cert', $CA, oi, tlsPk>, certOiSig> ),
     !MHTLeaf( $Log,
               <<'cert', $CA, <oi, rootKeyHash>, tlsPk>, certRootDSig>
     )
     ]
    --[
    Eq( z, true ), Eq( z.1, true ), VerifiedRootKey( oi, rootKeyHash ),
    RootCertVerified( <<'cert', $CA, <oi, rootKeyHash>, tlsPk>, 
                       certRootDSig>
    ),
    LogInclusionVerified( $Log, <'cert', $CA, oi, tlsPk> ),
    LogInclusionVerified( $Log, <'cert', $CA, <oi, rootKeyHash>, tlsPk>
    )
    ]->
     [ RootKeyVerified( oi, rootKeyHash ) ]
    variants (modulo AC)
    1. $CA   = $CA.13
       certOiSig
             = certOiSig.15
       certRootDSig
             = certRootDSig.16
       oi    = oi.17
       rootKeyHash
             = rootKeyHash.18
       skCA  = skCA.19
       tlsPk = tlsPk.20
       z     = verify(certOiSig.15, <'cert', $CA.13, oi.17, tlsPk.20>,
                      pk(skCA.19))
       z.1   = verify(certRootDSig.16,
                      <'cert', $CA.13, <oi.17, rootKeyHash.18>, tlsPk.20>, pk(skCA.19))
    
    2. $CA   = $CA.18
       certOiSig
             = sign(<'cert', $CA.18, oi.22, tlsPk.25>, skCA.24)
       certRootDSig
             = certRootDSig.21
       oi    = oi.22
       rootKeyHash
             = rootKeyHash.23
       skCA  = skCA.24
       tlsPk = tlsPk.25
       z     = true
       z.1   = verify(certRootDSig.21,
                      <'cert', $CA.18, <oi.22, rootKeyHash.23>, tlsPk.25>, pk(skCA.24))
    
    3. $CA   = $CA.18
       certOiSig
             = sign(<'cert', $CA.18, oi.22, tlsPk.25>, skCA.24)
       certRootDSig
             = sign(<'cert', $CA.18, <oi.22, rootKeyHash.23>, tlsPk.25>,
                    skCA.24)
       oi    = oi.22
       rootKeyHash
             = rootKeyHash.23
       skCA  = skCA.24
       tlsPk = tlsPk.25
       z     = true
       z.1   = true
    
    4. $CA   = $CA.20
       certOiSig
             = certOiSig.22
       certRootDSig
             = sign(<'cert', $CA.20, <oi.24, rootKeyHash.25>, tlsPk.27>,
                    skCA.26)
       oi    = oi.24
       rootKeyHash
             = rootKeyHash.25
       skCA  = skCA.26
       tlsPk = tlsPk.27
       z     = verify(certOiSig.22, <'cert', $CA.20, oi.24, tlsPk.27>,
                      pk(skCA.26))
       z.1   = true
  */

lemma CanObtainRootKey:
  exists-trace
  "(∃ oi rootKeyHash #t. VerifiedRootKey( oi, rootKeyHash ) @ #t) ∧
   (¬(∃ #x. SomeCompromise( ) @ #x))"
/*
guarded formula characterizing all satisfying traces:
"(∃ oi rootKeyHash #t. (VerifiedRootKey( oi, rootKeyHash ) @ #t)) ∧
 (∀ #x. (SomeCompromise( ) @ #x) ⇒ ⊥)"
*/
simplify
solve( !CA( $CA, skCA ) ▶₀ #t )
  case CA
  solve( !Log( $Log ) ▶₁ #t )
    case LogRegister
    solve( !MHTLeaf( $Log,
                     <<'cert', $CA, oi, tlsPk>, sign(<'cert', $CA, oi, tlsPk>, ~skCA)>
           ) ▶₂ #t )
      case Submit
      solve( !MHTLeaf( $Log,
                       <<'cert', $CA, <oi, rootKeyHash>, tlsPk>, 
                        sign(<'cert', $CA, <oi, rootKeyHash>, tlsPk>, ~skCA)>
             ) ▶₃ #t )
        case Submit
        solve( !KU( sign(<'cert', $CA, oi, tlsPk>, ~skCA) ) @ #vk.12 )
          case CertificateRequest_case_2
          solve( !KU( sign(<'cert', $CA, <$OI, rootKeyHash>, pk(~skTLS)>,
                           ~skCA)
                 ) @ #vk.14 )
            case CertificateRequest_case_3
            solve( !TLSKey( $A, $CA, $OI, ~skTLS ) ▶₀ #vr.13 )
              case TLSKeyRegister
              solve( !DomainOwner( $A, $OI ) ▶₁ #vr.12 )
                case DomainRegister
                solve( !KU( pk(~skTLS) ) @ #vk.14 )
                  case TLSKeyRegister
                  solve( !KU( sha256(pk(~rootKey)) ) @ #vk.15 )
                    case c_sha256
                    solve( !KU( pk(~rootKey) ) @ #vk.16 )
                      case Ltk
                      SOLVED // trace found
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

rule (modulo E) Asset:
   [ !LtkAsset( $E, assetKey ), !RootSetup( $P, rootKey, oi, rootD ) ]
  --[ IsAsset( $P, $E, pk(assetKey) ), OnlyOnce( <'asset', $E> ) ]->
   [ !AssetOf( $P, $E, assetKey ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) EndorseAsset:
   [
   !AssetOf( $P, $E, assetKey ),
   !RootDomains( $P, rootKey, oi, rootD )
   ]
  --[ OnlyOnce( <'endorsed', $E> ) ]->
   [ Out( sign(<'end_int', oi, pk(assetKey)>, rootKey) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) EndorseParty:
   [
   !RootDomains( $Endorsed, rootKeyT, oiT, rootDT ),
   !RootDomains( $Endorser, rootKeyS, oiS, rootDS )
   ]
  -->
   [ Out( sign(<'end_ext', oiS, oiT, pk(rootKeyT)>, rootKeyS) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) SendEmblem:
   [
   !AssetOf( $P, $E, assetKey ),
   !RootDomains( $P, rootKey, oi, rootD )
   ]
  -->
   [ Out( sign(<'emblem', $E, oi>, assetKey) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) ReceiveEmblem:
   [
   Fr( ~id ), In( <epk, <'emblem', $E, oi>, emblemSignature> ),
   In( <rootKey, <'end_int', oi, epk>, signature> ),
   RootKeyVerified( oi, sha256(rootKey) )
   ]
  --[
  VerifiedEndorsed( ~id, oi, $E, epk ),
  VerifiedRootEndorsement( ~id, oi, rootKey ),
  UsedRootKey( oi, rootKey ),
  Eq( verify(emblemSignature, <'emblem', $E, oi>, epk), true ),
  Eq( verify(signature, <'end_int', oi, epk>, rootKey), true )
  ]->
   [ VerifyAuthorityEndorsements( ~id, oi, rootKey, $E ) ]

  /*
  rule (modulo AC) ReceiveEmblem:
     [
     Fr( ~id ), In( <epk, <'emblem', $E, oi>, emblemSignature> ),
     In( <rootKey, <'end_int', oi, epk>, signature> ),
     RootKeyVerified( oi, sha256(rootKey) )
     ]
    --[
    VerifiedEndorsed( ~id, oi, $E, epk ),
    VerifiedRootEndorsement( ~id, oi, rootKey ),
    UsedRootKey( oi, rootKey ), Eq( z, true ), Eq( z.1, true )
    ]->
     [ VerifyAuthorityEndorsements( ~id, oi, rootKey, $E ) ]
    variants (modulo AC)
    1. $E    = $E.19
       emblemSignature
             = emblemSignature.21
       epk   = epk.22
       oi    = oi.23
       rootKey
             = rootKey.24
       signature
             = signature.25
       z     = verify(emblemSignature.21, <'emblem', $E.19, oi.23>,
                      epk.22)
       z.1   = verify(signature.25, <'end_int', oi.23, epk.22>,
                      rootKey.24)
    
    2. $E    = $E.26
       emblemSignature
             = emblemSignature.28
       epk   = epk.29
       oi    = oi.30
       rootKey
             = pk(x.50)
       signature
             = sign(<'end_int', oi.30, epk.29>, x.50)
       z     = verify(emblemSignature.28, <'emblem', $E.26, oi.30>,
                      epk.29)
       z.1   = true
    
    3. $E    = $E.27
       emblemSignature
             = sign(<'emblem', $E.27, oi.31>, x.52)
       epk   = pk(x.52)
       oi    = oi.31
       rootKey
             = rootKey.32
       signature
             = signature.33
       z     = true
       z.1   = verify(signature.33, <'end_int', oi.31, pk(x.52)>,
                      rootKey.32)
    
    4. $E    = $E.28
       emblemSignature
             = sign(<'emblem', $E.28, oi.32>, x.53)
       epk   = pk(x.53)
       oi    = oi.32
       rootKey
             = pk(x.54)
       signature
             = sign(<'end_int', oi.32, pk(x.53)>, x.54)
       z     = true
       z.1   = true
  */

rule (modulo E) VerifyAuthorityEndorsementsTerminate:
   [ VerifyAuthorityEndorsements( ~id, oi, rootKey, $E ) ] --> [ ]

  /* has exactly the trivial AC variant */

rule (modulo E) ReceiveAuthorityEndorsement:
   [
   VerifyAuthorityEndorsements( ~id, oi, rootKey, $E ), Fr( ~sess ),
   In( <authPk, <'end_ext', auth, oi, rootKey>, endSignature> ),
   RootKeyVerified( auth, sha256(authPk) )
   ]
  --[
  Neq( auth, oi ),
  Eq( verify(endSignature, <'end_ext', auth, oi, rootKey>, authPk),
      true
  ),
  VerifiedAuthorityEndorsement( ~id, auth, authPk, oi, rootKey ),
  UsedRootKey( auth, authPk )
  ]->
   [ VerifyAuthorityEndorsements( ~id, oi, rootKey, $E ) ]

  // loop breaker: [0]
  /*
  rule (modulo AC) ReceiveAuthorityEndorsement:
     [
     VerifyAuthorityEndorsements( ~id, oi, rootKey, $E ), Fr( ~sess ),
     In( <authPk, <'end_ext', auth, oi, rootKey>, endSignature> ),
     RootKeyVerified( auth, sha256(authPk) )
     ]
    --[
    Neq( auth, oi ), Eq( z, true ),
    VerifiedAuthorityEndorsement( ~id, auth, authPk, oi, rootKey ),
    UsedRootKey( auth, authPk )
    ]->
     [ VerifyAuthorityEndorsements( ~id, oi, rootKey, $E ) ]
    variants (modulo AC)
    1. auth  = auth.12
       authPk
             = authPk.13
       endSignature
             = endSignature.14
       oi    = oi.15
       rootKey
             = rootKey.16
       z     = verify(endSignature.14,
                      <'end_ext', auth.12, oi.15, rootKey.16>, authPk.13)
    
    2. auth  = auth.15
       authPk
             = pk(x.23)
       endSignature
             = sign(<'end_ext', auth.15, oi.18, rootKey.19>, x.23)
       oi    = oi.18
       rootKey
             = rootKey.19
       z     = true
    // loop breaker: [0]
  */

lemma CanReceiveEmblem:
  exists-trace
  "(∃ id oi asset assetKey rootKey authOi1 authOi2 authPk1 authPk2 p1
      p2 #a #b #c #d #e #f.
     ((((((VerifiedEndorsed( id, oi, asset, assetKey ) @ #a) ∧
          (VerifiedRootEndorsement( id, oi, rootKey ) @ #b)) ∧
         (VerifiedAuthorityEndorsement( id, authOi1, authPk1, oi, rootKey
          ) @ #c)) ∧
        (VerifiedAuthorityEndorsement( id, authOi2, authPk2, oi, rootKey
         ) @ #d)) ∧
       (IsRootPK( p1, authOi1, authPk1 ) @ #e)) ∧
      (IsRootPK( p2, authOi2, authPk2 ) @ #f)) ∧
     (¬(authOi1 = authOi2))) ∧
   (¬(∃ #x. SomeCompromise( ) @ #x))"
/*
guarded formula characterizing all satisfying traces:
"(∃ id oi asset assetKey rootKey authOi1 authOi2 authPk1 authPk2 p1
    p2 #a #b #c #d #e #f.
   (VerifiedEndorsed( id, oi, asset, assetKey ) @ #a) ∧
   (VerifiedRootEndorsement( id, oi, rootKey ) @ #b) ∧
   (VerifiedAuthorityEndorsement( id, authOi1, authPk1, oi, rootKey
    ) @ #c) ∧
   (VerifiedAuthorityEndorsement( id, authOi2, authPk2, oi, rootKey
    ) @ #d) ∧
   (IsRootPK( p1, authOi1, authPk1 ) @ #e) ∧
   (IsRootPK( p2, authOi2, authPk2 ) @ #f)
  ∧
   ¬(authOi1 = authOi2)) ∧
 (∀ #x. (SomeCompromise( ) @ #x) ⇒ ⊥)"
*/
simplify
solve( VerifyAuthorityEndorsements( ~id, oi, pk(x.1), $E.1
       ) ▶₀ #c )
  case ReceiveAuthorityEndorsement_case_1
  by sorry
next
  case ReceiveAuthorityEndorsement_case_2
  by contradiction /* from formulas */
next
  case ReceiveAuthorityEndorsement_case_3
  by contradiction /* from formulas */
next
  case ReceiveAuthorityEndorsement_case_4
  by contradiction /* from formulas */
next
  case ReceiveEmblem_case_1
  solve( VerifyAuthorityEndorsements( ~id, oi, pk(x.1), $E ) ▶₀ #d )
    case ReceiveAuthorityEndorsement_case_1
    solve( VerifyAuthorityEndorsements( ~id, oi, pk(x.1), $E
           ) ▶₀ #vr.7 )
      case ReceiveAuthorityEndorsement_case_1
      by sorry
    next
      case ReceiveAuthorityEndorsement_case_2
      by contradiction /* from formulas */
    next
      case ReceiveAuthorityEndorsement_case_3
      by contradiction /* from formulas */
    next
      case ReceiveAuthorityEndorsement_case_4
      by contradiction /* from formulas */
    next
      case ReceiveEmblem
      solve( !KU( sign(<'emblem', $E, oi>, x) ) @ #vk.25 )
        case FraudulentCertificate
        by contradiction /* from formulas */
      next
        case SendEmblem_case_01
        by contradiction /* from formulas */
      next
        case SendEmblem_case_02
        by contradiction /* from formulas */
      next
        case SendEmblem_case_03
        by contradiction /* from formulas */
      next
        case SendEmblem_case_04
        solve( !TLSKey( $P, $CA.2, $OI.3, ~skUser ) ▶₀ #vr.23 )
          case TLSKeyRegister
          solve( !DomainOwner( $P, $OI.3 ) ▶₁ #vr.28 )
            case DomainRegister
            solve( !KU( sign(<'end_int', $OI, pk(~assetKey)>, x) ) @ #vk.36 )
              case EndorseAsset
              solve( !KU( sign(<'end_ext', $OI.1, $OI, pk(~rootKey)>, ~rootKey.1)
                     ) @ #vk.50 )
                case EndorseParty
                solve( !KU( sign(<'end_ext', $OI.2, $OI, pk(~rootKey)>, ~rootKey.2)
                       ) @ #vk.54 )
                  case EndorseParty
                  solve( !KU( sign(<'cert', $CA, $OI, tlsPk>, ~skCA) ) @ #vk.61 )
                    case CertificateRequest_case_1
                    by contradiction /* from formulas */
                  next
                    case CertificateRequest_case_2
                    solve( !KU( sign(<'cert', $CA, <$OI, sha256(pk(~rootKey))>, 
                                      pk(~skTLS)>,
                                     ~skCA)
                           ) @ #vk.62 )
                      case CertificateRequest_case_1
                      by contradiction /* from formulas */
                    next
                      case CertificateRequest_case_2
                      by contradiction /* from formulas */
                    next
                      case CertificateRequest_case_3
                      solve( !TLSKey( $P, $CA, $OI, ~skTLS ) ▶₀ #vr.41 )
                        case TLSKeyRegister
                        solve( !DomainOwner( $P, $OI ) ▶₁ #vr.40 )
                          case DomainRegister
                          solve( !KU( sign(<'cert', $CA.1, $OI.1, tlsPk>, ~skCA.1)
                                 ) @ #vk.66 )
                            case CertificateRequest_case_1
                            by contradiction /* from formulas */
                          next
                            case CertificateRequest_case_2
                            solve( !KU( sign(<'cert', $CA.1, <$OI.1, sha256(pk(~rootKey.1))>, 
                                              pk(~skTLS.1)>,
                                             ~skCA.1)
                                   ) @ #vk.67 )
                              case CertificateRequest_case_1
                              by contradiction /* from formulas */
                            next
                              case CertificateRequest_case_2
                              by contradiction /* from formulas */
                            next
                              case CertificateRequest_case_3
                              solve( !TLSKey( $Party, $CA.1, $OI.1, ~skTLS.1 ) ▶₀ #vr.47 )
                                case TLSKeyRegister
                                solve( !DomainOwner( $Party, $OI.1 ) ▶₁ #vr.46 )
                                  case DomainRegister
                                  solve( !KU( sign(<'cert', $CA.2, $OI.3, pk(~skUser)>, ~skCA.2)
                                         ) @ #vk.74 )
                                    case CertificateRequest
                                    solve( !KU( sign(<'cert', $CA.2, 
                                                      <$OI.3, sha256(pk(~rootKey.3))>, pk(~skUser)>,
                                                     ~skCA.2)
                                           ) @ #vk.75 )
                                      case CertificateRequest
                                      solve( RootKeyVerified( $OI.2, sha256(pk(~rootKey.2))
                                             ) ▶₃ #d )
                                        case RootKeyLearn_case_1
                                        solve( !KU( sign(<'cert', $CA.3, $OI.2, tlsPk>, ~skCA.3)
                                               ) @ #vk.88 )
                                          case CertificateRequest_case_1
                                          by contradiction /* from formulas */
                                        next
                                          case CertificateRequest_case_2
                                          solve( !KU( sign(<'cert', $CA.3, 
                                                            <$OI.2, sha256(pk(~rootKey.2))>, 
                                                            pk(~skTLS.2)>,
                                                           ~skCA.3)
                                                 ) @ #vk.89 )
                                            case CertificateRequest_case_1
                                            by contradiction /* from formulas */
                                          next
                                            case CertificateRequest_case_2
                                            by contradiction /* from formulas */
                                          next
                                            case CertificateRequest_case_3
                                            solve( !TLSKey( $Party.1, $CA.3, $OI.2, ~skTLS.2
                                                   ) ▶₀ #vr.62 )
                                              case TLSKeyRegister
                                              solve( !DomainOwner( $Party.1, $OI.2 ) ▶₁ #vr.61 )
                                                case DomainRegister
                                                solve( !KU( pk(~assetKey) ) @ #vk.33 )
                                                  case AssetKey
                                                  solve( !KU( pk(~rootKey) ) @ #vk.53 )
                                                    case Ltk
                                                    solve( !KU( pk(~rootKey.1) ) @ #vk.55 )
                                                      case Ltk
                                                      solve( !KU( pk(~rootKey.2) ) @ #vk.65 )
                                                        case Ltk
                                                        solve( !KU( sha256(pk(~rootKey))
                                                               ) @ #vk.78 )
                                                          case c_sha256
                                                          solve( !KU( sha256(pk(~rootKey.1))
                                                                 ) @ #vk.81 )
                                                            case c_sha256
                                                            solve( !KU( pk(~skUser) ) @ #vk.86 )
                                                              case TLSKeyRegister
                                                              solve( !KU( pk(~rootKey.3)
                                                                     ) @ #vk.87 )
                                                                case Ltk
                                                                solve( !KU( pk(~skTLS) ) @ #vk.82 )
                                                                  case TLSKeyRegister
                                                                  solve( !KU( pk(~skTLS.1)
                                                                         ) @ #vk.85 )
                                                                    case TLSKeyRegister
                                                                    solve( !KU( sha256(pk(~rootKey.2))
                                                                           ) @ #vk.90 )
                                                                      case c_sha256
                                                                      solve( !KU( pk(~skTLS.2)
                                                                             ) @ #vk.90 )
                                                                        case TLSKeyRegister
                                                                        SOLVED // trace found
                                                                      next
                                                                        case c_pk
                                                                        by sorry
                                                                      qed
                                                                    qed
                                                                  next
                                                                    case c_pk
                                                                    by sorry
                                                                  qed
                                                                next
                                                                  case c_pk
                                                                  by sorry
                                                                qed
                                                              next
                                                                case c_pk
                                                                by sorry
                                                              qed
                                                            next
                                                              case c_pk
                                                              by sorry
                                                            qed
                                                          qed
                                                        qed
                                                      next
                                                        case c_pk
                                                        by sorry
                                                      qed
                                                    next
                                                      case c_pk
                                                      by sorry
                                                    qed
                                                  next
                                                    case c_pk
                                                    by sorry
                                                  qed
                                                next
                                                  case c_pk
                                                  by sorry
                                                qed
                                              qed
                                            qed
                                          next
                                            case FraudulentCertificate
                                            by contradiction /* from formulas */
                                          next
                                            case c_sign
                                            by sorry
                                          qed
                                        next
                                          case CertificateRequest_case_3
                                          by contradiction /* from formulas */
                                        next
                                          case CertificateRequest_case_4
                                          by sorry
                                        next
                                          case FraudulentCertificate
                                          by contradiction /* from formulas */
                                        next
                                          case c_sign
                                          by sorry
                                        qed
                                      next
                                        case RootKeyLearn_case_2
                                        by contradiction /* from formulas */
                                      next
                                        case RootKeyLearn_case_3
                                        by contradiction /* from formulas */
                                      next
                                        case RootKeyLearn_case_4
                                        by contradiction /* from formulas */
                                      qed
                                    next
                                      case FraudulentCertificate
                                      by contradiction /* from formulas */
                                    next
                                      case c_sign
                                      by sorry
                                    qed
                                  next
                                    case FraudulentCertificate
                                    by contradiction /* from formulas */
                                  next
                                    case c_sign
                                    by sorry
                                  qed
                                qed
                              qed
                            next
                              case FraudulentCertificate
                              by contradiction /* from formulas */
                            next
                              case c_sign
                              by sorry
                            qed
                          next
                            case CertificateRequest_case_3
                            by contradiction /* from formulas */
                          next
                            case CertificateRequest_case_4
                            by sorry
                          next
                            case FraudulentCertificate
                            by contradiction /* from formulas */
                          next
                            case c_sign
                            by sorry
                          qed
                        qed
                      qed
                    next
                      case FraudulentCertificate
                      by contradiction /* from formulas */
                    next
                      case c_sign
                      by sorry
                    qed
                  next
                    case CertificateRequest_case_3
                    by contradiction /* from formulas */
                  next
                    case CertificateRequest_case_4
                    by sorry
                  next
                    case FraudulentCertificate
                    by contradiction /* from formulas */
                  next
                    case c_sign
                    by sorry
                  qed
                next
                  case FraudulentCertificate
                  by contradiction /* from formulas */
                next
                  case c_sign
                  by sorry
                qed
              next
                case FraudulentCertificate
                by contradiction /* from formulas */
              next
                case c_sign
                by sorry
              qed
            next
              case FraudulentCertificate
              by contradiction /* from formulas */
            next
              case c_sign
              by sorry
            qed
          qed
        qed
      next
        case SendEmblem_case_05
        by contradiction /* from formulas */
      next
        case SendEmblem_case_06
        by contradiction /* from formulas */
      next
        case SendEmblem_case_07
        by contradiction /* from formulas */
      next
        case SendEmblem_case_08
        by contradiction /* from formulas */
      next
        case SendEmblem_case_09
        by contradiction /* from formulas */
      next
        case SendEmblem_case_10
        by contradiction /* from formulas */
      next
        case SendEmblem_case_11
        by contradiction /* from formulas */
      next
        case SendEmblem_case_12
        by contradiction /* from formulas */
      next
        case SendEmblem_case_13
        by contradiction /* from formulas */
      next
        case SendEmblem_case_14
        by contradiction /* from formulas */
      next
        case SendEmblem_case_15
        by contradiction /* from formulas */
      next
        case SendEmblem_case_16
        by contradiction /* from formulas */
      next
        case SendEmblem_case_17
        by contradiction /* from formulas */
      next
        case SendEmblem_case_18
        by contradiction /* from formulas */
      next
        case SendEmblem_case_19
        by contradiction /* from formulas */
      next
        case SendEmblem_case_20
        by sorry
      next
        case SendEmblem_case_21
        by contradiction /* from formulas */
      next
        case SendEmblem_case_22
        by contradiction /* from formulas */
      next
        case SendEmblem_case_23
        by contradiction /* from formulas */
      next
        case SendEmblem_case_24
        by contradiction /* from formulas */
      next
        case SendEmblem_case_25
        by contradiction /* from formulas */
      next
        case SendEmblem_case_26
        by contradiction /* from formulas */
      next
        case SendEmblem_case_27
        by contradiction /* from formulas */
      next
        case SendEmblem_case_28
        by contradiction /* from formulas */
      next
        case SendEmblem_case_29
        by contradiction /* from formulas */
      next
        case SendEmblem_case_30
        by contradiction /* from formulas */
      next
        case SendEmblem_case_31
        by contradiction /* from formulas */
      next
        case SendEmblem_case_32
        by contradiction /* from formulas */
      next
        case SendEmblem_case_33
        by contradiction /* from formulas */
      next
        case SendEmblem_case_34
        by contradiction /* from formulas */
      next
        case SendEmblem_case_35
        by contradiction /* from formulas */
      next
        case SendEmblem_case_36
        by sorry
      next
        case SendEmblem_case_37
        by contradiction /* from formulas */
      next
        case SendEmblem_case_38
        by contradiction /* from formulas */
      next
        case SendEmblem_case_39
        by contradiction /* from formulas */
      next
        case SendEmblem_case_40
        by contradiction /* from formulas */
      next
        case SendEmblem_case_41
        by contradiction /* from formulas */
      next
        case SendEmblem_case_42
        by contradiction /* from formulas */
      next
        case SendEmblem_case_43
        by contradiction /* from formulas */
      next
        case SendEmblem_case_44
        by contradiction /* from formulas */
      next
        case SendEmblem_case_45
        by contradiction /* from formulas */
      next
        case SendEmblem_case_46
        by contradiction /* from formulas */
      next
        case SendEmblem_case_47
        by contradiction /* from formulas */
      next
        case SendEmblem_case_48
        by contradiction /* from formulas */
      next
        case c_sign
        by sorry
      qed
    qed
  next
    case ReceiveAuthorityEndorsement_case_2
    by contradiction /* from formulas */
  next
    case ReceiveAuthorityEndorsement_case_3
    by contradiction /* from formulas */
  next
    case ReceiveAuthorityEndorsement_case_4
    by contradiction /* from formulas */
  next
    case ReceiveEmblem
    by contradiction /* from formulas */
  qed
next
  case ReceiveEmblem_case_2
  by contradiction /* from formulas */
next
  case ReceiveEmblem_case_3
  by contradiction /* from formulas */
next
  case ReceiveEmblem_case_4
  by contradiction /* from formulas */
qed

lemma VerifiedAuthorityOrigin [reuse, use_induction]:
  all-traces
  "∀ loop auth authKey oi rootKey #t1.
    (VerifiedAuthorityEndorsement( loop, auth, authKey, oi, rootKey
     ) @ #t1) ⇒
    ((∃ #t2.
       (VerifiedRootEndorsement( loop, oi, rootKey ) @ #t2) ∧
       (#t2 < #t1)) ∧
     (∀ p1 p2 rk1 rk2 #t2 #t3.
       ((VerifiedRootEndorsement( loop, p1, rk1 ) @ #t2) ∧
        (VerifiedRootEndorsement( loop, p2, rk2 ) @ #t3)) ⇒
       (((((oi = p1) ∧ (p1 = p2)) ∧ (#t2 = #t3)) ∧ (rootKey = rk1)) ∧
        (rk1 = rk2))))"
/*
guarded formula characterizing all counter-examples:
"∃ loop auth authKey oi rootKey #t1.
  (VerifiedAuthorityEndorsement( loop, auth, authKey, oi, rootKey
   ) @ #t1)
 ∧
  ((∀ #t2.
     (VerifiedRootEndorsement( loop, oi, rootKey ) @ #t2)
    ⇒
     ¬(#t2 < #t1)) ∨
   (∃ p1 p2 rk1 rk2 #t2 #t3.
     (VerifiedRootEndorsement( loop, p1, rk1 ) @ #t2) ∧
     (VerifiedRootEndorsement( loop, p2, rk2 ) @ #t3)
    ∧
     ((¬(oi = p1)) ∨
      (¬(p1 = p2)) ∨
      (¬(#t2 = #t3)) ∨
      (¬(rootKey = rk1)) ∨
      (¬(rk1 = rk2)))))"
*/
induction
  case empty_trace
  by contradiction /* from formulas */
next
  case non_empty_trace
  simplify
  solve( (∀ #t2.
           (VerifiedRootEndorsement( ~id, oi, rootKey ) @ #t2)
          ⇒
           ¬(#t2 < #t1))  ∥
         (∃ p1 p2 rk1 rk2 #t2 #t3.
           (VerifiedRootEndorsement( ~id, p1, rk1 ) @ #t2) ∧
           (VerifiedRootEndorsement( ~id, p2, rk2 ) @ #t3)
          ∧
           ((¬(oi = p1)) ∨
            (¬(p1 = p2)) ∨
            (¬(#t2 = #t3)) ∨
            (¬(rootKey = rk1)) ∨
            (¬(rk1 = rk2)))) )
    case case_1
    solve( (last(#t1))  ∥
           ((∃ #t2.
              (VerifiedRootEndorsement( ~id, oi, rootKey ) @ #t2)
             ∧
              (¬(last(#t2))) ∧ (#t2 < #t1)) ∧
            (∀ p1 p2 rk1 rk2 #t2 #t3.
              (VerifiedRootEndorsement( ~id, p1, rk1 ) @ #t2) ∧
              (VerifiedRootEndorsement( ~id, p2, rk2 ) @ #t3)
             ⇒
              ((last(#t3)) ∨
               (last(#t2)) ∨
               ((oi = p1) ∧
                (p1 = p2) ∧
                (#t2 = #t3) ∧
                (rootKey = rk1) ∧
                (rk1 = rk2))))) )
      case case_1
      solve( VerifyAuthorityEndorsements( ~id, oi, rootKey, $E ) ▶₀ #t1 )
        case ReceiveAuthorityEndorsement_case_1
        by contradiction /* from formulas */
      next
        case ReceiveAuthorityEndorsement_case_2
        by contradiction /* from formulas */
      next
        case ReceiveAuthorityEndorsement_case_3
        by contradiction /* from formulas */
      next
        case ReceiveAuthorityEndorsement_case_4
        by contradiction /* from formulas */
      next
        case ReceiveEmblem_case_1
        by contradiction /* from formulas */
      next
        case ReceiveEmblem_case_2
        by contradiction /* from formulas */
      next
        case ReceiveEmblem_case_3
        by contradiction /* from formulas */
      next
        case ReceiveEmblem_case_4
        by contradiction /* from formulas */
      qed
    next
      case case_2
      by contradiction /* from formulas */
    qed
  next
    case case_2
    solve( (last(#t1))  ∥
           ((∃ #t2.
              (VerifiedRootEndorsement( ~id, oi, rootKey ) @ #t2)
             ∧
              (¬(last(#t2))) ∧ (#t2 < #t1)) ∧
            (∀ p1 p2 rk1 rk2 #t2 #t3.
              (VerifiedRootEndorsement( ~id, p1, rk1 ) @ #t2) ∧
              (VerifiedRootEndorsement( ~id, p2, rk2 ) @ #t3)
             ⇒
              ((last(#t3)) ∨
               (last(#t2)) ∨
               ((oi = p1) ∧
                (p1 = p2) ∧
                (#t2 = #t3) ∧
                (rootKey = rk1) ∧
                (rk1 = rk2))))) )
      case case_1
      solve( VerifyAuthorityEndorsements( ~id, oi, rootKey, $E ) ▶₀ #t1 )
        case ReceiveAuthorityEndorsement_case_1
        by contradiction /* from formulas */
      next
        case ReceiveAuthorityEndorsement_case_2
        by contradiction /* from formulas */
      next
        case ReceiveAuthorityEndorsement_case_3
        by contradiction /* from formulas */
      next
        case ReceiveAuthorityEndorsement_case_4
        by contradiction /* from formulas */
      next
        case ReceiveEmblem_case_1
        by contradiction /* from formulas */
      next
        case ReceiveEmblem_case_2
        by contradiction /* from formulas */
      next
        case ReceiveEmblem_case_3
        by contradiction /* from formulas */
      next
        case ReceiveEmblem_case_4
        by contradiction /* from formulas */
      qed
    next
      case case_2
      by contradiction /* from formulas */
    qed
  qed
qed

lemma AuthenticEmblem:
  all-traces
  "∀ id oi asset assetKey rootKey #t1 #t2.
    ((VerifiedEndorsed( id, oi, asset, assetKey ) @ #t1) ∧
     (VerifiedRootEndorsement( id, oi, rootKey ) @ #t2)) ⇒
    (((((∃ pp #x #y.
          (OI( pp, oi ) @ #x) ∧ (IsAsset( pp, asset, assetKey ) @ #y)) ∨
        (∃ p #x #y.
          (OI( p, oi ) @ #x) ∧ (CompromisedADEMParty( p, rootKey ) @ #y))) ∨
       (∃ otherA #x. CompromisedAssetKey( otherA, assetKey ) @ #x)) ∨
      (¬(∃ authOi authPk endorsedKey #t3.
          VerifiedAuthorityEndorsement( id, authPk, authOi, oi, endorsedKey
          ) @ #t3))) ∨
     (∀ authOI authPk endorsedKey #x.
       (VerifiedAuthorityEndorsement( id, authOI, authPk, oi, endorsedKey
        ) @ #x) ⇒
       ((∃ p #y #z.
          (OI( p, authOI ) @ #y) ∧
          (CompromisedADEMParty( p, authPk ) @ #z)) ∨
        (¬(∃ p #y. IsRootPK( p, authOI, authPk ) @ #y)))))"
/*
guarded formula characterizing all counter-examples:
"∃ id oi asset assetKey rootKey #t1 #t2.
  (VerifiedEndorsed( id, oi, asset, assetKey ) @ #t1) ∧
  (VerifiedRootEndorsement( id, oi, rootKey ) @ #t2)
 ∧
  (∀ pp #x #y.
    (OI( pp, oi ) @ #x) ∧ (IsAsset( pp, asset, assetKey ) @ #y) ⇒ ⊥) ∧
  (∀ p #x #y.
    (OI( p, oi ) @ #x) ∧ (CompromisedADEMParty( p, rootKey ) @ #y)
   ⇒
    ⊥) ∧
  (∀ otherA #x. (CompromisedAssetKey( otherA, assetKey ) @ #x) ⇒ ⊥) ∧
  (∃ authOi authPk endorsedKey #t3.
    (VerifiedAuthorityEndorsement( id, authPk, authOi, oi, endorsedKey
     ) @ #t3)) ∧
  (∃ authOI authPk endorsedKey #x.
    (VerifiedAuthorityEndorsement( id, authOI, authPk, oi, endorsedKey
     ) @ #x)
   ∧
    (∀ p #y #z.
      (OI( p, authOI ) @ #y) ∧ (CompromisedADEMParty( p, authPk ) @ #z)
     ⇒
      ⊥) ∧
    (∃ p #y. (IsRootPK( p, authOI, authPk ) @ #y)))"
*/
simplify
solve( !Ltk( $Party, ~rootKey ) ▶₀ #y )
  case Ltk
  solve( !KU( sign(<'emblem', $E, oi>, x) ) @ #vk.13 )
    case FraudulentCertificate
    solve( !KU( sign(<'end_int', oi, pk(~skCA)>, x) ) @ #vk.20 )
      case FraudulentCertificate
      solve( !KU( sign(<'end_ext', $OI, oi, pk(~skCA.1)>, ~rootKey)
             ) @ #vk.31 )
        case c_sign
        solve( !KU( ~rootKey ) @ #vk.32 )
          case Reveal
          by contradiction /* from formulas */
        qed
      qed
    next
      case c_sign
      solve( !KU( sign(<'end_ext', $OI, oi, pk(x)>, ~rootKey)
             ) @ #vk.31 )
        case EndorseParty
        solve( !KU( ~rootKey ) @ #vk.32 )
          case Reveal
          by contradiction /* from formulas */
        qed
      next
        case c_sign
        solve( !KU( ~rootKey ) @ #vk.33 )
          case Reveal
          by contradiction /* from formulas */
        qed
      qed
    qed
  next
    case SendEmblem_case_01
    by contradiction /* from formulas */
  next
    case SendEmblem_case_02
    by contradiction /* from formulas */
  next
    case SendEmblem_case_03
    by contradiction /* from formulas */
  next
    case SendEmblem_case_04
    by contradiction /* from formulas */
  next
    case SendEmblem_case_05
    by contradiction /* from formulas */
  next
    case SendEmblem_case_06
    by contradiction /* from formulas */
  next
    case SendEmblem_case_07
    by contradiction /* from formulas */
  next
    case SendEmblem_case_08
    by contradiction /* from formulas */
  next
    case SendEmblem_case_09
    by contradiction /* from formulas */
  next
    case SendEmblem_case_10
    by contradiction /* from formulas */
  next
    case SendEmblem_case_11
    by contradiction /* from formulas */
  next
    case SendEmblem_case_12
    by contradiction /* from formulas */
  next
    case SendEmblem_case_13
    by contradiction /* from formulas */
  next
    case SendEmblem_case_14
    by contradiction /* from formulas */
  next
    case SendEmblem_case_15
    by contradiction /* from formulas */
  next
    case SendEmblem_case_16
    by contradiction /* from formulas */
  next
    case SendEmblem_case_17
    by contradiction /* from formulas */
  next
    case SendEmblem_case_18
    by contradiction /* from formulas */
  next
    case SendEmblem_case_19
    by contradiction /* from formulas */
  next
    case SendEmblem_case_20
    by contradiction /* from formulas */
  next
    case SendEmblem_case_21
    by contradiction /* from formulas */
  next
    case SendEmblem_case_22
    by contradiction /* from formulas */
  next
    case SendEmblem_case_23
    by contradiction /* from formulas */
  next
    case SendEmblem_case_24
    by contradiction /* from formulas */
  next
    case SendEmblem_case_25
    by contradiction /* from formulas */
  next
    case SendEmblem_case_26
    by contradiction /* from formulas */
  next
    case SendEmblem_case_27
    by contradiction /* from formulas */
  next
    case SendEmblem_case_28
    by contradiction /* from formulas */
  next
    case SendEmblem_case_29
    by contradiction /* from formulas */
  next
    case SendEmblem_case_30
    by contradiction /* from formulas */
  next
    case SendEmblem_case_31
    by contradiction /* from formulas */
  next
    case SendEmblem_case_32
    by contradiction /* from formulas */
  next
    case SendEmblem_case_33
    by contradiction /* from formulas */
  next
    case SendEmblem_case_34
    by contradiction /* from formulas */
  next
    case SendEmblem_case_35
    by contradiction /* from formulas */
  next
    case SendEmblem_case_36
    by contradiction /* from formulas */
  next
    case SendEmblem_case_37
    by contradiction /* from formulas */
  next
    case SendEmblem_case_38
    by contradiction /* from formulas */
  next
    case SendEmblem_case_39
    by contradiction /* from formulas */
  next
    case SendEmblem_case_40
    by contradiction /* from formulas */
  next
    case SendEmblem_case_41
    by contradiction /* from formulas */
  next
    case SendEmblem_case_42
    by contradiction /* from formulas */
  next
    case SendEmblem_case_43
    by contradiction /* from formulas */
  next
    case SendEmblem_case_44
    by contradiction /* from formulas */
  next
    case SendEmblem_case_45
    by contradiction /* from formulas */
  next
    case SendEmblem_case_46
    by contradiction /* from formulas */
  next
    case SendEmblem_case_47
    by contradiction /* from formulas */
  next
    case SendEmblem_case_48
    by contradiction /* from formulas */
  next
    case c_sign
    solve( !KU( sign(<'end_int', oi, pk(x)>, x.1) ) @ #vk.20 )
      case EndorseAsset_case_01
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_02
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_03
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_04
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_05
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_06
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_07
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_08
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_09
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_10
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_11
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_12
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_13
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_14
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_15
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_16
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_17
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_18
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_19
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_20
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_21
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_22
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_23
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_24
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_25
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_26
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_27
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_28
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_29
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_30
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_31
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_32
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_33
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_34
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_35
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_36
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_37
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_38
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_39
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_40
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_41
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_42
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_43
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_44
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_45
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_46
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_47
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case EndorseAsset_case_48
      solve( !KU( ~assetKey ) @ #vk.33 )
        case RevealAsset
        by contradiction /* from formulas */
      qed
    next
      case FraudulentCertificate
      solve( !KU( sign(<'end_ext', $OI, oi, pk(~skCA)>, ~rootKey)
             ) @ #vk.31 )
        case c_sign
        solve( !KU( ~rootKey ) @ #vk.33 )
          case Reveal
          by contradiction /* from formulas */
        qed
      qed
    next
      case c_sign
      solve( !KU( sign(<'end_ext', $OI, oi, pk(x.1)>, ~rootKey)
             ) @ #vk.31 )
        case EndorseParty
        solve( !KU( ~rootKey ) @ #vk.33 )
          case Reveal
          by contradiction /* from formulas */
        qed
      next
        case c_sign
        solve( !KU( ~rootKey ) @ #vk.34 )
          case Reveal
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
qed

rule (modulo E) MonitorMaliciousTLSKeys:
   [
   !MHTLeaf( $Log, <<'cert', $SigningCA, d, pkTLS>, sig> ),
   !TLSKey( $P, $CA, d, skTLS ), !CA( $SigningCA, skCA )
   ]
  --[
  Neq( pk(skTLS), pkTLS ),
  Eq( verify(sig, <'cert', $SigningCA, d, pkTLS>, pk(skCA)), true )
  ]->
   [ SendDispute( $P, $Log, $SigningCA, d, pkTLS ) ]

  /*
  rule (modulo AC) MonitorMaliciousTLSKeys:
     [
     !MHTLeaf( $Log, <<'cert', $SigningCA, d, pkTLS>, sig> ),
     !TLSKey( $P, $CA, d, skTLS ), !CA( $SigningCA, skCA )
     ]
    --[ Neq( pk(skTLS), pkTLS ), Eq( z, true ) ]->
     [ SendDispute( $P, $Log, $SigningCA, d, pkTLS ) ]
    variants (modulo AC)
    1. $SigningCA
             = $SigningCA.13
       d     = d.14
       pkTLS = pkTLS.15
       sig   = sig.16
       skCA  = skCA.17
       z     = verify(sig.16, <'cert', $SigningCA.13, d.14, pkTLS.15>,
                      pk(skCA.17))
    
    2. $SigningCA
             = $SigningCA.16
       d     = d.17
       pkTLS = pkTLS.18
       sig   = sign(<'cert', $SigningCA.16, d.17, pkTLS.18>, skCA.20)
       skCA  = skCA.20
       z     = true
  */

rule (modulo E) AdversarialDispute:
   [ In( d ), In( pk ) ]
  --[ CompromisedParty( $P ) ]->
   [ SendDispute( $P, $Log, $SigningCA, d, pk ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) DisputeReceived:
   [ SendDispute( $P, $Log, $SigningCA, d, pkTLS ) ]
  --[ Dispute( $P, $Log, $SigningCA, d, pkTLS ) ]->
   [ ]

  /* has exactly the trivial AC variant */

lemma CanDispute1:
  exists-trace
  "∃ p log ca d pk #t.
    (Dispute( p, log, ca, d, pk ) @ #t) ∧
    (¬(∃ #x. CompromisedParty( p ) @ #x))"
/*
guarded formula characterizing all satisfying traces:
"∃ p log ca d pk #t.
  (Dispute( p, log, ca, d, pk ) @ #t)
 ∧
  ∀ #x. (CompromisedParty( p ) @ #x) ⇒ ⊥"
*/
simplify
solve( SendDispute( $P, $Log, $SigningCA, d, pk ) ▶₀ #t )
  case MonitorMaliciousTLSKeys_case_02
  solve( !KU( sign(<'cert', $SigningCA, $OI, pk>, ~skCA) ) @ #vk.8 )
    case FraudulentCertificate
    SOLVED // trace found
  qed
qed

rule (modulo E) MonitorMaliciousRootKeys:
   [
   !MHTLeaf( $Log, <<'cert', $SigningCA, <oi, rk_h>, pkTLS>, sig> ),
   !RootSetup( $P, rootKey, oi, rootD )
   ]
  --[ Neq( rk_h, sha256(pk(rootKey)) ) ]->
   [ SendRootKeyDispute( $P, <oi, rk_h> ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) AdversarialRootKeyDispute:
   [ In( d ) ]
  --[ CompromisedParty( $P ) ]->
   [ SendRootKeyDispute( $P, d ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) RootKeyDisputeReceived:
   [ SendRootKeyDispute( $P, d ) ] --[ RootKeyDispute( $P, d ) ]-> [ ]

  /* has exactly the trivial AC variant */

lemma CanDispute2:
  exists-trace
  "∃ p d #x.
    (RootKeyDispute( p, d ) @ #x) ∧
    (¬(∃ #t. CompromisedParty( p ) @ #t))"
/*
guarded formula characterizing all satisfying traces:
"∃ p d #x.
  (RootKeyDispute( p, d ) @ #x)
 ∧
  ∀ #t. (CompromisedParty( p ) @ #t) ⇒ ⊥"
*/
simplify
solve( SendRootKeyDispute( $P, d ) ▶₀ #x )
  case MonitorMaliciousRootKeys_case_04
  solve( !DomainOwner( $P, $OI ) ▶₁ #vr.13 )
    case DomainRegister
    solve( !KU( sign(<'cert', $SigningCA, <$OI, rk_h>, pkTLS>, ~skCA)
           ) @ #vk.15 )
      case FraudulentCertificate
      solve( !KU( sign(<'cert', $CA, $OI, pk(~skUser)>, ~skCA.1)
             ) @ #vk.23 )
        case CertificateRequest
        solve( !KU( sign(<'cert', $CA, <$OI, sha256(pk(~rootKey))>, 
                          pk(~skUser)>,
                         ~skCA.1)
               ) @ #vk.24 )
          case CertificateRequest
          solve( !KU( pk(~skUser) ) @ #vk.24 )
            case TLSKeyRegister
            solve( !KU( pk(~rootKey) ) @ #vk.25 )
              case Ltk
              solve( !TLSKey( $P, $CA, $OI, ~skUser ) ▶₀ #vr.8 )
                case TLSKeyRegister
                SOLVED // trace found
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma CAAccountability:
  all-traces
  "∀ p log ca d pk skCA #t2 #t3.
    ((Dispute( p, log, ca, d, pk ) @ #t2) ∧
     (LogInclusion( log,
                    <<'cert', ca, d, pk>, sign(<'cert', ca, d, pk>, skCA)>
      ) @ #t3)) ⇒
    ((∃ #a. CompromisedParty( ca ) @ #a) ∨
     (∃ #a. CompromisedParty( p ) @ #a))"
/*
guarded formula characterizing all counter-examples:
"∃ p log ca d pk skCA #t2 #t3.
  (Dispute( p, log, ca, d, pk ) @ #t2) ∧
  (LogInclusion( log,
                 <<'cert', ca, d, pk>, sign(<'cert', ca, d, pk>, skCA)>
   ) @ #t3)
 ∧
  (∀ #a. (CompromisedParty( ca ) @ #a) ⇒ ⊥) ∧
  (∀ #a. (CompromisedParty( p ) @ #a) ⇒ ⊥)"
*/
simplify
solve( SendDispute( $P, $Log, $SigningCA, d, pk ) ▶₀ #t2 )
  case AdversarialDispute
  by contradiction /* from formulas */
next
  case MonitorMaliciousTLSKeys_case_01
  by contradiction /* from formulas */
next
  case MonitorMaliciousTLSKeys_case_02
  solve( !KU( sign(<'cert', $SigningCA, $OI, pk>, ~skCA) ) @ #vk.8 )
    case CertificateRequest
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by contradiction /* from formulas */
  next
    case c_sign
    by solve( !KU( ~skCA ) @ #vk.9 )
  qed
next
  case MonitorMaliciousTLSKeys_case_03
  by contradiction /* from formulas */
next
  case MonitorMaliciousTLSKeys_case_04
  solve( !KU( sign(<'cert', $SigningCA, <$OI, sha256(pk(~rootKey))>, 
                    pk>,
                   ~skCA)
         ) @ #vk.9 )
    case CertificateRequest
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by contradiction /* from formulas */
  next
    case c_sign
    by solve( !KU( ~skCA ) @ #vk.12 )
  qed
next
  case MonitorMaliciousTLSKeys_case_05
  by contradiction /* from formulas */
next
  case MonitorMaliciousTLSKeys_case_06
  solve( !KU( sign(<'cert', $SigningCA, $OI, pk>, ~skCA) ) @ #vk.8 )
    case CertificateRequest
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by contradiction /* from formulas */
  next
    case c_sign
    by solve( !KU( ~skCA ) @ #vk.9 )
  qed
next
  case MonitorMaliciousTLSKeys_case_07
  by contradiction /* from formulas */
next
  case MonitorMaliciousTLSKeys_case_08
  solve( !KU( sign(<'cert', $SigningCA, <$OI, sha256(pk(~rootKey))>, 
                    pk>,
                   ~skCA)
         ) @ #vk.9 )
    case CertificateRequest
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by contradiction /* from formulas */
  next
    case c_sign
    by solve( !KU( ~skCA ) @ #vk.12 )
  qed
next
  case MonitorMaliciousTLSKeys_case_09
  by contradiction /* from formulas */
next
  case MonitorMaliciousTLSKeys_case_10
  solve( !KU( sign(<'cert', $SigningCA, $OI, pk>, ~skCA) ) @ #vk.8 )
    case CertificateRequest
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by contradiction /* from formulas */
  next
    case c_sign
    by solve( !KU( ~skCA ) @ #vk.9 )
  qed
next
  case MonitorMaliciousTLSKeys_case_11
  by contradiction /* from formulas */
next
  case MonitorMaliciousTLSKeys_case_12
  solve( !KU( sign(<'cert', $SigningCA, <$OI, sha256(pk(~rootKey))>, 
                    pk>,
                   ~skCA)
         ) @ #vk.9 )
    case CertificateRequest
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by contradiction /* from formulas */
  next
    case c_sign
    by solve( !KU( ~skCA ) @ #vk.12 )
  qed
next
  case MonitorMaliciousTLSKeys_case_13
  by contradiction /* from formulas */
next
  case MonitorMaliciousTLSKeys_case_14
  solve( !KU( sign(<'cert', $SigningCA, $OI, pk>, ~skCA) ) @ #vk.8 )
    case CertificateRequest
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by contradiction /* from formulas */
  next
    case c_sign
    by solve( !KU( ~skCA ) @ #vk.9 )
  qed
next
  case MonitorMaliciousTLSKeys_case_15
  by contradiction /* from formulas */
next
  case MonitorMaliciousTLSKeys_case_16
  solve( !KU( sign(<'cert', $SigningCA, <$OI, sha256(pk(~rootKey))>, 
                    pk>,
                   ~skCA)
         ) @ #vk.9 )
    case CertificateRequest
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by contradiction /* from formulas */
  next
    case c_sign
    by solve( !KU( ~skCA ) @ #vk.12 )
  qed
qed

lemma AuthorityAccountability:
  all-traces
  "∀ p pAuth oi rkFalse id oiAuth rkAuth #t1 #t2 #t3.
    (((IsRootPK( pAuth, oiAuth, rkAuth ) @ #t1) ∧
      (RootKeyDispute( p, <oi, sha256(rkFalse)> ) @ #t2)) ∧
     (VerifiedAuthorityEndorsement( id, oiAuth, rkAuth, oi, rkFalse
      ) @ #t3)) ⇒
    ((∃ #a. CompromisedParty( pAuth ) @ #a) ∨
     (∃ #a. CompromisedParty( p ) @ #a))"
/*
guarded formula characterizing all counter-examples:
"∃ p pAuth oi rkFalse id oiAuth rkAuth #t1 #t2 #t3.
  (IsRootPK( pAuth, oiAuth, rkAuth ) @ #t1) ∧
  (RootKeyDispute( p, <oi, sha256(rkFalse)> ) @ #t2) ∧
  (VerifiedAuthorityEndorsement( id, oiAuth, rkAuth, oi, rkFalse
   ) @ #t3)
 ∧
  (∀ #a. (CompromisedParty( pAuth ) @ #a) ⇒ ⊥) ∧
  (∀ #a. (CompromisedParty( p ) @ #a) ⇒ ⊥)"
*/
simplify
solve( SendRootKeyDispute( $P, <oi, sha256(pk(x))> ) ▶₀ #t2 )
  case AdversarialRootKeyDispute
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_01
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_02
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_03
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_04
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_05
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_06
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_07
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_08
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_09
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_10
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_11
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_12
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_13
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_14
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_15
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_16
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_17
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_18
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_19
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_20
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_21
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_22
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_23
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_24
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_25
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_26
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_27
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_28
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_29
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_30
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_31
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_32
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_33
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_34
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_35
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_36
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_37
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_38
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_39
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_40
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_41
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_42
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_43
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_44
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_45
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_46
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_47
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_48
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_49
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_50
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_51
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_52
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_53
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_54
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_55
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_56
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_57
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_58
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_59
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_60
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_61
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_62
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_63
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_64
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_65
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_66
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_67
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_68
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_69
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_70
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_71
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_72
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_73
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_74
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_75
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_76
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_77
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_78
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_79
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_80
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_81
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_82
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_83
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_84
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_85
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_86
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_87
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_88
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_89
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_90
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_91
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_92
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
next
  case MonitorMaliciousRootKeys_case_93
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_94
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_95
  by contradiction /* from formulas */
next
  case MonitorMaliciousRootKeys_case_96
  solve( !KU( sign(<'end_ext', $OI, $OI.1, pk(x)>, ~rootKey)
         ) @ #vk.19 )
    case EndorseParty
    by contradiction /* from formulas */
  next
    case FraudulentCertificate
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case c_sign
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      solve( !KU( ~rootKey ) @ #vk.50 )
        case Reveal
        by contradiction /* from formulas */
      qed
    qed
  qed
qed

lemma PPAccountability:
  all-traces
  "∀ p oi rk e1 assetKey id #t1 #t2 #t3.
    ((((IsRootPK( p, oi, rk ) @ #t1) ∧
       (¬(∃ e2 #x. IsAsset( p, e2, assetKey ) @ #x))) ∧
      (VerifiedRootEndorsement( id, oi, rk ) @ #t2)) ∧
     (VerifiedEndorsed( id, oi, e1, assetKey ) @ #t3)) ⇒
    (∃ #a. CompromisedParty( p ) @ #a)"
/*
guarded formula characterizing all counter-examples:
"∃ p oi rk e1 assetKey id #t1 #t2 #t3.
  (IsRootPK( p, oi, rk ) @ #t1) ∧
  (VerifiedRootEndorsement( id, oi, rk ) @ #t2) ∧
  (VerifiedEndorsed( id, oi, e1, assetKey ) @ #t3)
 ∧
  (∀ e2 #x. (IsAsset( p, e2, assetKey ) @ #x) ⇒ ⊥) ∧
  (∀ #a. (CompromisedParty( p ) @ #a) ⇒ ⊥)"
*/
simplify
solve( !KU( sign(<'end_int', $OI, pk(x)>, ~rootKey) ) @ #vk.15 )
  case EndorseAsset_case_01
  by contradiction /* from formulas */
next
  case EndorseAsset_case_02
  by contradiction /* from formulas */
next
  case EndorseAsset_case_03
  by contradiction /* from formulas */
next
  case EndorseAsset_case_04
  by contradiction /* from formulas */
next
  case EndorseAsset_case_05
  by contradiction /* from formulas */
next
  case EndorseAsset_case_06
  by contradiction /* from formulas */
next
  case EndorseAsset_case_07
  by contradiction /* from formulas */
next
  case EndorseAsset_case_08
  by contradiction /* from formulas */
next
  case EndorseAsset_case_09
  by contradiction /* from formulas */
next
  case EndorseAsset_case_10
  by contradiction /* from formulas */
next
  case EndorseAsset_case_11
  by contradiction /* from formulas */
next
  case EndorseAsset_case_12
  by contradiction /* from formulas */
next
  case EndorseAsset_case_13
  by contradiction /* from formulas */
next
  case EndorseAsset_case_14
  by contradiction /* from formulas */
next
  case EndorseAsset_case_15
  by contradiction /* from formulas */
next
  case EndorseAsset_case_16
  by contradiction /* from formulas */
next
  case EndorseAsset_case_17
  by contradiction /* from formulas */
next
  case EndorseAsset_case_18
  by contradiction /* from formulas */
next
  case EndorseAsset_case_19
  by contradiction /* from formulas */
next
  case EndorseAsset_case_20
  by contradiction /* from formulas */
next
  case EndorseAsset_case_21
  by contradiction /* from formulas */
next
  case EndorseAsset_case_22
  by contradiction /* from formulas */
next
  case EndorseAsset_case_23
  by contradiction /* from formulas */
next
  case EndorseAsset_case_24
  by contradiction /* from formulas */
next
  case EndorseAsset_case_25
  by contradiction /* from formulas */
next
  case EndorseAsset_case_26
  by contradiction /* from formulas */
next
  case EndorseAsset_case_27
  by contradiction /* from formulas */
next
  case EndorseAsset_case_28
  by contradiction /* from formulas */
next
  case EndorseAsset_case_29
  by contradiction /* from formulas */
next
  case EndorseAsset_case_30
  by contradiction /* from formulas */
next
  case EndorseAsset_case_31
  by contradiction /* from formulas */
next
  case EndorseAsset_case_32
  by contradiction /* from formulas */
next
  case EndorseAsset_case_33
  by contradiction /* from formulas */
next
  case EndorseAsset_case_34
  by contradiction /* from formulas */
next
  case EndorseAsset_case_35
  by contradiction /* from formulas */
next
  case EndorseAsset_case_36
  by contradiction /* from formulas */
next
  case EndorseAsset_case_37
  by contradiction /* from formulas */
next
  case EndorseAsset_case_38
  by contradiction /* from formulas */
next
  case EndorseAsset_case_39
  by contradiction /* from formulas */
next
  case EndorseAsset_case_40
  by contradiction /* from formulas */
next
  case EndorseAsset_case_41
  by contradiction /* from formulas */
next
  case EndorseAsset_case_42
  by contradiction /* from formulas */
next
  case EndorseAsset_case_43
  by contradiction /* from formulas */
next
  case EndorseAsset_case_44
  by contradiction /* from formulas */
next
  case EndorseAsset_case_45
  by contradiction /* from formulas */
next
  case EndorseAsset_case_46
  by contradiction /* from formulas */
next
  case EndorseAsset_case_47
  by contradiction /* from formulas */
next
  case EndorseAsset_case_48
  by contradiction /* from formulas */
next
  case FraudulentCertificate
  by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
next
  case c_sign
  solve( !KU( ~rootKey ) @ #vk.16 )
    case Reveal
    solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
      case Ltk
      by contradiction /* from formulas */
    qed
  next
    case RevealAsset
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case TLSKeyLeak_case_1
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case TLSKeyLeak_case_2
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case TLSKeyLeak_case_3
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case TLSKeyLeak_case_4
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case TLSKeyLeak_case_5
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case TLSKeyLeak_case_6
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case TLSKeyLeak_case_7
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case TLSKeyLeak_case_8
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  next
    case fresh
    by solve( !Ltk( $Party, ~rootKey ) ▶₀ #t1 )
  qed
qed

lemma UsedRootKey1:
  all-traces
  "∀ id oi rk #t.
    (VerifiedRootEndorsement( id, oi, rk ) @ #t) ⇒
    (UsedRootKey( oi, rk ) @ #t)"
/*
guarded formula characterizing all counter-examples:
"∃ id oi rk #t.
  (VerifiedRootEndorsement( id, oi, rk ) @ #t)
 ∧
  ¬(UsedRootKey( oi, rk ) @ #t)"
*/
simplify
by contradiction /* from formulas */

lemma UsedRootKey2:
  all-traces
  "∀ id oiAuth rkAuth oi rkFalse #t.
    (VerifiedAuthorityEndorsement( id, oiAuth, rkAuth, oi, rkFalse
     ) @ #t) ⇒
    (UsedRootKey( oiAuth, rkAuth ) @ #t)"
/*
guarded formula characterizing all counter-examples:
"∃ id oiAuth rkAuth oi rkFalse #t.
  (VerifiedAuthorityEndorsement( id, oiAuth, rkAuth, oi, rkFalse
   ) @ #t)
 ∧
  ¬(UsedRootKey( oiAuth, rkAuth ) @ #t)"
*/
simplify
by contradiction /* from formulas */

lemma RootKeyUse:
  all-traces
  "∀ oi rk #t.
    (UsedRootKey( oi, rk ) @ #t) ⇒
    (∃ ca caSk log certBody1 certBody2 oi.1 tlsPk #x #y #z.
      ((((CASk( ca, caSk ) @ #x) ∧
         (certBody1 = <'cert', ca, oi.1, tlsPk>)) ∧
        (certBody2 = <'cert', ca, <oi.1, sha256(rk)>, tlsPk>)) ∧
       (LogInclusion( log, <certBody1, sign(certBody1, caSk)> ) @ #y)) ∧
      (LogInclusion( log, <certBody2, sign(certBody2, caSk)> ) @ #z))"
/*
guarded formula characterizing all counter-examples:
"∃ oi rk #t.
  (UsedRootKey( oi, rk ) @ #t)
 ∧
  ∀ ca caSk log certBody1 certBody2 oi.1 tlsPk #x #y #z.
   (CASk( ca, caSk ) @ #x) ∧
   (certBody1 = <'cert', ca, oi.1, tlsPk>) ∧
   (certBody2 = <'cert', ca, <oi.1, sha256(rk)>, tlsPk>) ∧
   (LogInclusion( log, <certBody1, sign(certBody1, caSk)> ) @ #y) ∧
   (LogInclusion( log, <certBody2, sign(certBody2, caSk)> ) @ #z)
  ⇒
   ⊥"
*/
simplify
solve( UsedRootKey( oi, rk ) @ #t )
  case ReceiveAuthorityEndorsement
  solve( VerifyAuthorityEndorsements( ~id, oi, pk(x), $E ) ▶₀ #t )
    case ReceiveAuthorityEndorsement_case_1
    solve( RootKeyVerified( oi.1, sha256(pk(x.1)) ) ▶₃ #t )
      case RootKeyLearn_case_1
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_2
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_3
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_4
      by contradiction /* from formulas */
    qed
  next
    case ReceiveAuthorityEndorsement_case_2
    solve( RootKeyVerified( oi.1, sha256(pk(x.1)) ) ▶₃ #t )
      case RootKeyLearn_case_1
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_2
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_3
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_4
      by contradiction /* from formulas */
    qed
  next
    case ReceiveAuthorityEndorsement_case_3
    solve( RootKeyVerified( oi.1, sha256(pk(x.1)) ) ▶₃ #t )
      case RootKeyLearn_case_1
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_2
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_3
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_4
      by contradiction /* from formulas */
    qed
  next
    case ReceiveAuthorityEndorsement_case_4
    solve( RootKeyVerified( oi.1, sha256(pk(x.1)) ) ▶₃ #t )
      case RootKeyLearn_case_1
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_2
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_3
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_4
      by contradiction /* from formulas */
    qed
  next
    case ReceiveEmblem_case_1
    solve( RootKeyVerified( oi.1, sha256(pk(x.1)) ) ▶₃ #t )
      case RootKeyLearn_case_1
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_2
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_3
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_4
      by contradiction /* from formulas */
    qed
  next
    case ReceiveEmblem_case_2
    solve( RootKeyVerified( oi.1, sha256(pk(x.1)) ) ▶₃ #t )
      case RootKeyLearn_case_1
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_2
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_3
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_4
      by contradiction /* from formulas */
    qed
  next
    case ReceiveEmblem_case_3
    solve( RootKeyVerified( oi.1, sha256(pk(x.1)) ) ▶₃ #t )
      case RootKeyLearn_case_1
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_2
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_3
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_4
      by contradiction /* from formulas */
    qed
  next
    case ReceiveEmblem_case_4
    solve( RootKeyVerified( oi.1, sha256(pk(x.1)) ) ▶₃ #t )
      case RootKeyLearn_case_1
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_2
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_3
      by contradiction /* from formulas */
    next
      case RootKeyLearn_case_4
      by contradiction /* from formulas */
    qed
  qed
next
  case ReceiveEmblem
  solve( RootKeyVerified( oi, sha256(pk(x.1)) ) ▶₃ #t )
    case RootKeyLearn_case_1
    by contradiction /* from formulas */
  next
    case RootKeyLearn_case_2
    by contradiction /* from formulas */
  next
    case RootKeyLearn_case_3
    by contradiction /* from formulas */
  next
    case RootKeyLearn_case_4
    by contradiction /* from formulas */
  qed
qed

restriction Eq:
  "∀ a b #i. (Eq( a, b ) @ #i) ⇒ (a = b)"
  // safety formula

restriction Neq:
  "∀ a b #i. (Neq( a, b ) @ #i) ⇒ (¬(a = b))"
  // safety formula

restriction OnlyOnce:
  "∀ #i #j a.
    ((OnlyOnce( a ) @ #i) ∧ (OnlyOnce( a ) @ #j)) ⇒ (#i = #j)"
  // safety formula

























/* All wellformedness checks were successful. */

/*
Generated from:
Tamarin version 1.10.0
Maude version 3.2.1
Git revision: UNKNOWN, branch: UNKNOWN
Compiled at: 2024-10-30 13:42:18.081591 UTC
*/

end